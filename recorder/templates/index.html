<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotFlow Recorder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="flex h-screen">
        <!-- Left Panel: Controls -->
        <div class="w-96 bg-gray-800 border-r border-gray-700 flex flex-col overflow-y-auto">
            <!-- Header -->
            <div class="p-4 border-b border-gray-700">
                <h1 class="text-xl font-bold text-blue-400">BotFlow Recorder</h1>
                <p class="text-sm text-gray-400 mt-1">Record automation flows visually</p>
            </div>

            <!-- Start Recording -->
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-sm font-semibold text-gray-300 mb-2">New Recording</h2>
                <input id="flow-id" type="text" placeholder="Flow ID (e.g. my_login)"
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm mb-2 focus:border-blue-500 focus:outline-none">
                <input id="site-name" type="text" placeholder="Site (e.g. example.com)"
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm mb-2 focus:border-blue-500 focus:outline-none">
                <div class="flex gap-2">
                    <button onclick="startRecording()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium">
                        Start Recording
                    </button>
                    <button onclick="stopRecording()"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium">
                        Save Flow
                    </button>
                </div>
            </div>

            <!-- Status -->
            <div class="p-4 border-b border-gray-700" id="status-section"
                hx-get="/api/recording-status" hx-trigger="every 2s" hx-swap="innerHTML">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-gray-500"></span>
                    <span class="text-sm text-gray-400">Not recording</span>
                </div>
            </div>

            <!-- Steps List -->
            <div class="p-4 flex-1">
                <h2 class="text-sm font-semibold text-gray-300 mb-2">Recorded Steps</h2>
                <div id="steps-list" class="space-y-2"
                    hx-get="/api/current-flow" hx-trigger="every 1s" hx-swap="innerHTML"
                    hx-select-oob="#steps-content">
                    <p class="text-sm text-gray-500">No steps recorded yet.</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Instructions -->
        <div class="flex-1 flex items-center justify-center p-8">
            <div class="max-w-lg text-center">
                <div class="text-6xl mb-4">&#127916;</div>
                <h2 class="text-2xl font-bold mb-4">How to Record</h2>
                <ol class="text-left text-gray-300 space-y-3">
                    <li class="flex gap-3">
                        <span class="text-blue-400 font-bold">1.</span>
                        Enter a Flow ID and Site name, then click "Start Recording"
                    </li>
                    <li class="flex gap-3">
                        <span class="text-blue-400 font-bold">2.</span>
                        A browser window will open. Navigate to the target site.
                    </li>
                    <li class="flex gap-3">
                        <span class="text-blue-400 font-bold">3.</span>
                        Click "Select" in the floating toolbar to enter selection mode.
                    </li>
                    <li class="flex gap-3">
                        <span class="text-blue-400 font-bold">4.</span>
                        Click elements on the page to capture them as steps.
                    </li>
                    <li class="flex gap-3">
                        <span class="text-blue-400 font-bold">5.</span>
                        Use "Extract" mode to capture text content from elements.
                    </li>
                    <li class="flex gap-3">
                        <span class="text-blue-400 font-bold">6.</span>
                        Click "Save Flow" when done. A .flow.json file will be created.
                    </li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        async function startRecording() {
            const flowId = document.getElementById('flow-id').value;
            const site = document.getElementById('site-name').value;
            if (!flowId || !site) { alert('Please enter Flow ID and Site'); return; }
            const res = await fetch('/api/start-recording', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({flow_id: flowId, site: site})
            });
            const data = await res.json();
            updateStatus(true);
        }

        async function stopRecording() {
            const res = await fetch('/api/stop-recording', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            });
            const data = await res.json();
            if (data.status === 'saved') {
                alert('Flow saved to ' + data.path + ' (' + data.step_count + ' steps)');
                updateStatus(false);
            } else {
                alert('Error: ' + JSON.stringify(data));
            }
        }

        function updateStatus(active) {
            const section = document.getElementById('status-section');
            const color = active ? 'bg-red-500' : 'bg-gray-500';
            const text = active ? 'Recording...' : 'Not recording';
            section.innerHTML = `<div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full ${color} ${active ? 'animate-pulse' : ''}"></span>
                <span class="text-sm ${active ? 'text-red-400' : 'text-gray-400'}">${text}</span>
            </div>`;
        }

        // Poll for steps
        setInterval(async () => {
            try {
                const res = await fetch('/api/current-flow');
                const data = await res.json();
                const list = document.getElementById('steps-list');
                if (data.steps && data.steps.length > 0) {
                    list.innerHTML = data.steps.map((s, i) => `
                        <div class="bg-gray-700 rounded p-2 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-blue-300 font-mono">${s.id}</span>
                                <span class="px-2 py-0.5 rounded text-xs bg-gray-600">${s.action}</span>
                            </div>
                            <p class="text-gray-400 text-xs mt-1">${s.description || ''}</p>
                            <p class="text-gray-500 text-xs font-mono mt-1">${s.target?.css || ''}</p>
                        </div>
                    `).join('');
                }
            } catch(e) {}
        }, 1000);
    </script>
</body>
</html>
